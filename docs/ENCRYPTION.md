# 本地加密存储功能

## 概述

MCP Sync 现在支持对本地配置文件进行加密存储，保护你的敏感信息（如 GitHub Token、Gist ID、加密密码等）不被明文读取。

## 加密特性

### ✅ 自动加密
- 当用户设置加密密码后，所有本地配置文件会自动加密
- 支持加密的文件类型：
  - `sync_config.json` - 主配置文件
  - `versions/*.json` - 版本历史
  - `logs/*.json` - 同步日志

### ✅ 无缝透明
- 加密和解密对用户完全透明
- 应用程序自动检测并处理加密文件
- 支持从明文文件自动升级到加密文件

### ✅ 安全标准
- 使用 **AES-256-GCM** 加密算法
- 每个文件都有唯一的初始化向量 (IV)
- 加密文件以 `ENC:` 标记开头

## 工作原理

### 1. 启用加密

当用户在设置页面配置加密密码并保存时：

```
用户设置密码 → 保存配置 → 自动启用本地加密 → 所有文件加密存储
```

### 2. 加载配置

当应用程序启动或读取配置时：

```
读取文件 → 检测 ENC: 标记 → 使用密码解密 → 正常返回数据
```

### 3. 自动升级

如果配置文件包含加密设置但文件还未加密：

```
加载配置 → 检测到加密设置 → 自动加密文件 → 标记为已加密
```

## 安全注意事项

### ⚠️ 重要提醒

1. **密码丢失 = 数据不可恢复**
   - 请务必记住你的加密密码
   - 如果密码丢失，已加密的配置无法恢复

2. **密码强度建议**
   - 最少 8 个字符
   - 包含大小写字母、数字和特殊字符
   - 例如：`MySecur3P@ss!`

3. **定期更换密码**
   - 建议每 3-6 个月更换一次加密密码
   - 更换密码前请先备份配置

## 使用指南

### 首次设置加密

1. 打开 MCP Sync 应用
2. 进入 **设置** 页面
3. 填入你的 GitHub Token 和 Gist ID
4. 勾选 **"启用加密"** 选项
5. 输入并确认加密密码
6. 点击 **"保存设置"**
7. 应用会自动加密所有本地文件

### 查看加密状态

加密后的文件示例：

```json
ENC:U2FsdGVkX1+...
```

明文文件示例：

```json
{
  "id": "default",
  "servers": [],
  ...
}
```

## 技术实现

### 加密流程

```
明文JSON → AES-256-GCM加密 → Base64编码 → 添加ENC:前缀 → 保存文件
```

### 解密流程

```
读取文件 → 检测ENC: → 移除ENC: → Base64解码 → AES-256-GCM解密 → JSON解析
```

### 密钥派生

使用用户提供的密码直接作为 AES-256 密钥（通过填充或截断到 32 字节）。

## 兼容性

- ✅ 向后兼容：现有明文文件会被自动加密
- ✅ 跨平台：Windows、macOS、Linux
- ✅ 透明访问：应用程序自动处理加密/解密

## 故障排除

### 错误："failed to decrypt file"

**原因**：密码错误或文件损坏

**解决方案**：
1. 检查输入的加密密码是否正确
2. 如果是首次加载，可能是旧版本文件，重新设置加密密码
3. 如果问题持续，可能需要从 Gist 重新拉取配置

### 错误："file is encrypted but no encryption key provided"

**原因**：应用程序未启用加密但尝试读取加密文件

**解决方案**：
1. 在设置页面重新配置加密密码
2. 确保勾选了"启用加密"选项
3. 保存设置后重启应用

## 更新日志

### v2.0.0
- ✅ 新增本地配置文件加密功能
- ✅ 支持 AES-256-GCM 加密算法
- ✅ 自动检测并升级明文文件
- ✅ 透明加密/解密操作

## 支持

如有问题或建议，请查看 [SECURITY.md](SECURITY.md) 或提交 Issue。
